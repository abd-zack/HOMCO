<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neumorphic Relay Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto px-4">
        <header class="flex flex-col items-center mb-8">
      
          <!-- Judul Tengah -->
          <div class="text-center font-['Poppins'] mb-4">
            <h1 class="text-3xl tracking-widest font-bold text-gray-800 drop-shadow-lg [text-shadow:_1px_1px_0_ #e0e0e0]">HOMCO</h1>
            <p class="text-sm text-gray-100">By zacky</p>
          </div>
      
          <!-- Baris bawah: Status (kiri), Setting (kanan) -->
          <div class="flex justify-between items-center w-full">
            
            <!-- Kiri: Status + Connect -->
            <div class="flex items-center gap-3">
              <div id="connection-status" class="flex items-center text-sm neumorphic px-3 py-2 rounded-lg">
                <span class="connection-dot disconnected"></span>
                <span class="text-gray-800">Disconnected</span>
              </div>
              <button id="connect-btn" class="neumorphic-btn neumorphic-btn-primary px-4 py-2 rounded-lg text-sm">
                Connect
              </button>
            </div>
      
            <!-- Kanan: Tombol Setting -->
            <button id="open-settings" class="w-10 h-10 rounded-full neumorphic-btn flex items-center justify-center">
              <i class="fas fa-cog text-gray-600"></i>
            </button>
          </div>
      
        </header>
      </div>
      
        <!-- Main Content -->
        <main>
             <!-- Relay Cards Grid -->
             <div class="mb-8">
                <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="relay-cards-container">
                    <!-- Relay cards will be added here -->
                </div>
                <div class="flex justify-center items-center mt-6 mb-6">
                    <div class="flex justify-center mt-6 mb-6">
                        <div class="w-full max-w-sm border-t border-gray-300 flex justify-center items-center pt-4">
                          <button id="add-relay-btn"
                            class="flex items-center justify-center gap-2 px-4 py-2 text-sm text-gray-600 border border-gray-300 rounded-full 
                                   hover:bg-gray-100 transition-all duration-200 active:scale-95 shadow-sm">
                            <i class="fas fa-plus text-sm"></i>
                            <span>Tambah</span>
                          </button>
                        </div>
                      </div>                      
            </div>


            <!-- Stats Overview -->
            <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 max-w-full">
                <!-- Connected Relays -->
                <div class="bg-[#e0e0e0] p-3 rounded-xl shadow-inner hover:shadow-md transition duration-300 border-2 border-[#ffffff80]">
                  <div class="flex justify-between items-center">
                    <div>
                      <p class="text-sm text-gray-500">Connected</p>
                      <h3 class="text-xl font-bold" id="connected-relays">0</h3>
                    </div>
                    <div class="w-12 h-12 rounded-full flex items-center justify-center bg-blue-100 text-blue-500 shadow">
                      <i class="fas fa-plug text-xl"></i>
                    </div>
                  </div>
                </div>
              
                <!-- Active Relays -->
                <div class="bg-[#e0e0e0] p-4 rounded-xl shadow-inner hover:shadow-md transition duration-200 border-2 border-[#ffffff80]">
                  <div class="flex justify-between items-center">
                    <div>
                      <p class="text-sm text-gray-500">Active</p>
                      <h3 class="text-xl font-bold" id="active-relays">0</h3>
                    </div>
                    <div class="w-12 h-12 rounded-full flex items-center justify-center bg-green-100 text-green-500 shadow">
                      <i class="fas fa-bolt text-xl"></i>
                    </div>
                  </div>
                </div>
              
                <!-- MQTT Status -->
                <div class="bg-[#e0e0e0] p-4 rounded-xl shadow-inner hover:shadow-md transition duration-200 border-2 border-[#ffffff80]">
                  <div class="flex justify-between items-center">
                    <div>
                      <p class="text-sm text-gray-500">Status</p>
                      <h3 class="text-xl font-bold" id="mqtt-status">Offline</h3>
                    </div>
                    <div class="w-12 h-12 rounded-full flex items-center justify-center bg-red-100 text-red-500 shadow">
                      <i class="fas fa-wifi text-xl"></i>
                    </div>
                  </div>
                </div>
              
                <!-- Last Update -->
                <div class="bg-[#e0e0e0] p-4 rounded-xl shadow-inner hover:shadow-md transition duration-200 border-2 border-[#ffffff80]">
                  <div class="flex justify-between items-center">
                    <div>
                      <p class="text-sm text-gray-500">Last Update</p>
                      <h3 class="text-md font-bold" id="last-update">Never</h3>
                    </div>
                    <div class="w-12 h-12 rounded-full flex items-center justify-center bg-purple-100 text-purple-500 shadow">
                      <i class="fas fa-clock text-xl"></i>
                    </div>
                  </div>
                </div>
              </div>

           
        </main>
    </div>

    <!-- Add Relay Modal -->
    <div id="add-relay-modal" class="modal-overlay hidden">
        <div class="neumorphic bg-white rounded-xl w-full max-w-md mx-4 overflow-hidden">
            <div class="p-5 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Add Card</h3>
            </div>
            <div class="p-5 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Card Name</label>
                    <input type="text" id="relay-name" class="w-full p-3 neumorphic-inset rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g. Living Room Light">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Topic</label>
                    <input type="text" id="relay-topic" class="w-full p-3 neumorphic-inset rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="home/relay/1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Initial State</label>
                    <select id="relay-initial-state" class="w-full p-3 neumorphic-inset rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="off">Off</option>
                        <option value="on">On</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Icon</label>
                    <select id="relay-icon" class="w-full p-3 neumorphic-inset rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="fas fa-lightbulb">Light Bulb</option>
                        <option value="fas fa-plug">Plug</option>
                        <option value="fa-fan">Fan</option>
                        <option value="fas fa-tv">TV</option>
                        <option value="fas fa-thermometer">Thermometer</option>
                        <option value="fas fa-lock">Lock</option>
                        <option value="fas fa-door-open">Door</option>
                        <option value="fas fa-water">Water</option>
                    </select>
                </div>
            </div>
            <div class="p-5 border-t border-gray-200 flex justify-end space-x-3">
                <button id="cancel-add-relay" class="neumorphic-btn px-4 py-2 rounded-md text-sm font-medium text-gray-700">
                    Batal
                </button>
                <button id="confirm-add-relay" class="neumorphic-btn neumorphic-btn-primary px-4 py-2 rounded-md text-sm font-medium">
                    Tambah
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Relay Modal -->
    <div id="edit-relay-modal" class="modal-overlay hidden">
        <div class="neumorphic bg-white rounded-xl w-full max-w-md mx-4 overflow-hidden">
            <div class="p-5 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">Edit</h3>
            </div>
            <div class="p-5 space-y-4">
                <input type="hidden" id="edit-relay-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="edit-relay-name" class="w-full p-3 neumorphic-inset rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Topic</label>
                    <input type="text" id="edit-relay-topic" class="w-full p-3 neumorphic-inset rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Icon</label>
                    <select id="edit-relay-icon" class="w-full p-3 neumorphic-inset rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="fas fa-lightbulb">Light Bulb</option>
                        <option value="fas fa-plug">Plug</option>
                        <option value="fas fa-fan">Fan</option>
                        <option value="fas fa-tv">TV</option>
                        <option value="fas fa-thermometer">Thermometer</option>
                        <option value="fas fa-lock">Lock</option>
                        <option value="fas fa-door-open">Door</option>
                        <option value="fas fa-water">Water</option>
                    </select>
                </div>
            </div>
            <div class="p-5 border-t border-gray-200 flex justify-between">
                <button id="delete-relay" class="neumorphic-btn neumorphic-btn-danger px-4 py-2 rounded-md text-sm font-medium">
                    <i class="fas fa-trash mr-2"></i> Hapus
                </button>
                <div class="space-x-3">
                    <button id="cancel-edit-relay" class="neumorphic-btn px-4 py-2 rounded-md text-sm font-medium text-gray-700">
                        Kembali
                    </button>
                    <button id="confirm-edit-relay" class="neumorphic-btn neumorphic-btn-primary px-4 py-2 rounded-md text-sm font-medium">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div id="settings-panel" class="settings-panel neumorphic">
        <div class="h-full flex flex-col">
            <div class="p-5 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold">Connection Settings</h3>
                <button id="close-settings" class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-5 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Broker URL</label>
                    <input type="text" id="broker-url" class="w-full p-3 neumorphic-inset rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="wss://broker.emqx.io:8084/mqtt">
                    <p class="text-xs text-gray-500 mt-1">Supported protocols: ws, wss, mqtt, mqtts</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Client ID</label>
                    <input type="text" id="client-id" class="w-full p-3 neumorphic-inset rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="web_relay_control_">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="username" class="w-full p-3 neumorphic-inset rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Optional">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" class="w-full p-3 neumorphic-inset rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Optional">
                </div>
                <div class="pt-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="auto-connect" class="rounded neumorphic text-blue-600 focus:ring-blue-500" checked>
                        <span class="ml-2 text-sm text-gray-700">Auto-connect on page load</span>
                    </label>
                </div>
                <div class="pt-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="retain-messages" class="rounded neumorphic text-blue-600 focus:ring-blue-500">
                        <span class="ml-2 text-sm text-gray-700">Retain messages</span>
                    </label>
                </div>
                <div class="pt-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="clean-session" class="rounded neumorphic text-blue-600 focus:ring-blue-500" checked>
                        <span class="ml-2 text-sm text-gray-700">Clean session</span>
                    </label>
                </div>
                <div class="pt-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Advanced Options</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Keepalive (seconds)</label>
                            <input type="number" id="keepalive" class="w-full p-2 neumorphic-inset rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="60" min="5">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Reconnect Period (ms)</label>
                            <input type="number" id="reconnect-period" class="w-full p-2 neumorphic-inset rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="1000" min="100">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Connect Timeout (ms)</label>
                            <input type="number" id="connect-timeout" class="w-full p-2 neumorphic-inset rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="30000" min="1000">
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-5 border-t border-gray-200">
                <button id="save-settings" class="w-full py-3 neumorphic-btn neumorphic-btn-primary rounded-md text-sm font-medium">
                    Save & Connect
                </button>
            </div>
        </div>
    </div>

    <script>
        // MQTT Client
        let mqttClient = null;
        const relayCards = [];
        
        // DOM Elements
        const connectBtn = document.getElementById('connect-btn');
        const connectionStatus = document.getElementById('connection-status');
        const connectionDot = connectionStatus.querySelector('.connection-dot');
        const openSettingsBtn = document.getElementById('open-settings');
        const closeSettingsBtn = document.getElementById('close-settings');
        const settingsPanel = document.getElementById('settings-panel');
        const saveSettingsBtn = document.getElementById('save-settings');
        const addRelayBtn = document.getElementById('add-relay-btn');
        const addRelayModal = document.getElementById('add-relay-modal');
        const editRelayModal = document.getElementById('edit-relay-modal');
        const cancelAddRelayBtn = document.getElementById('cancel-add-relay');
        const confirmAddRelayBtn = document.getElementById('confirm-add-relay');
        const cancelEditRelayBtn = document.getElementById('cancel-edit-relay');
        const confirmEditRelayBtn = document.getElementById('confirm-edit-relay');
        const deleteRelayBtn = document.getElementById('delete-relay');
        const relayCardsContainer = document.getElementById('relay-cards-container');
        const connectedRelaysSpan = document.getElementById('connected-relays');
        const activeRelaysSpan = document.getElementById('active-relays');
        const mqttStatusSpan = document.getElementById('mqtt-status');
        const lastUpdateSpan = document.getElementById('last-update');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved relays from localStorage
            loadSavedRelays();
            
            // Load settings from localStorage
            loadSettings();
            
            // Auto-connect if enabled
            if (document.getElementById('auto-connect').checked) {
                connectToMQTT();
            }
            
            // Event Listeners
            connectBtn.addEventListener('click', toggleMQTTConnection);
            openSettingsBtn.addEventListener('click', openSettings);
            closeSettingsBtn.addEventListener('click', closeSettings);
            addRelayBtn.addEventListener('click', () => addRelayModal.classList.remove('hidden'));
            cancelAddRelayBtn.addEventListener('click', () => addRelayModal.classList.add('hidden'));
            confirmAddRelayBtn.addEventListener('click', addNewRelay);
            cancelEditRelayBtn.addEventListener('click', () => editRelayModal.classList.add('hidden'));
            confirmEditRelayBtn.addEventListener('click', updateRelay);
            deleteRelayBtn.addEventListener('click', deleteRelay);
            saveSettingsBtn.addEventListener('click', saveSettings);
            
            // Update stats
            updateStats();
        });
        
        function loadSavedRelays() {
            const savedRelays = JSON.parse(localStorage.getItem('relayControlRelays')) || [];
            savedRelays.forEach(relay => {
                createRelayCard(relay);
                relayCards.push(relay);
            });
            updateStats();
        }
        
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('relayControlSettings')) || {};
            
            if (settings.brokerUrl) document.getElementById('broker-url').value = settings.brokerUrl;
            if (settings.clientId) document.getElementById('client-id').value = settings.clientId;
            if (settings.username) document.getElementById('username').value = settings.username;
            if (settings.password) document.getElementById('password').value = settings.password;
            if (settings.autoConnect !== undefined) document.getElementById('auto-connect').checked = settings.autoConnect;
            if (settings.retainMessages !== undefined) document.getElementById('retain-messages').checked = settings.retainMessages;
            if (settings.cleanSession !== undefined) document.getElementById('clean-session').checked = settings.cleanSession;
            if (settings.keepalive) document.getElementById('keepalive').value = settings.keepalive;
            if (settings.reconnectPeriod) document.getElementById('reconnect-period').value = settings.reconnectPeriod;
            if (settings.connectTimeout) document.getElementById('connect-timeout').value = settings.connectTimeout;
        }
        
        function saveSettings() {
            const settings = {
                brokerUrl: document.getElementById('broker-url').value,
                clientId: document.getElementById('client-id').value,
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                autoConnect: document.getElementById('auto-connect').checked,
                retainMessages: document.getElementById('retain-messages').checked,
                cleanSession: document.getElementById('clean-session').checked,
                keepalive: parseInt(document.getElementById('keepalive').value),
                reconnectPeriod: parseInt(document.getElementById('reconnect-period').value),
                connectTimeout: parseInt(document.getElementById('connect-timeout').value)
            };
            
            localStorage.setItem('relayControlSettings', JSON.stringify(settings));
            closeSettings();
            
            // Reconnect with new settings
            if (mqttClient && mqttClient.connected) {
                disconnectFromMQTT();
            }
            connectToMQTT();
        }
        
        function toggleMQTTConnection() {
            if (mqttClient && mqttClient.connected) {
                disconnectFromMQTT();
            } else {
                connectToMQTT();
            }
        }
        
        function connectToMQTT() {
            const brokerUrl = document.getElementById('broker-url').value;
            const clientId = document.getElementById('client-id').value + Math.random().toString(16).substr(2, 8);
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const retainMessages = document.getElementById('retain-messages').checked;
            const cleanSession = document.getElementById('clean-session').checked;
            const keepalive = parseInt(document.getElementById('keepalive').value);
            const reconnectPeriod = parseInt(document.getElementById('reconnect-period').value);
            const connectTimeout = parseInt(document.getElementById('connect-timeout').value);
            
            updateConnectionStatus('connecting');
            
            const options = {
                clientId: clientId,
                username: username || undefined,
                password: password || undefined,
                clean: cleanSession,
                reconnectPeriod: reconnectPeriod,
                connectTimeout: connectTimeout,
                keepalive: keepalive
            };
            
            try {
                mqttClient = mqtt.connect(brokerUrl, options);
                
                mqttClient.on('connect', function() {
                    updateConnectionStatus('connected');
                    console.log('Connected to MQTT broker');
                    
                    // Subscribe to all saved topics
                    relayCards.forEach(relay => {
                        mqttClient.subscribe(relay.topic, { qos: 1 }, function(err) {
                            if (!err) {
                                console.log(`Subscribed to ${relay.topic}`);
                            }
                        });
                    });
                    
                    updateStats();
                });
                
                mqttClient.on('message', function(topic, message) {
                    const payload = message.toString();
                    console.log(`Message received on ${topic}: ${payload}`);
                    
                    // Find the relay that matches this topic
                    const relay = relayCards.find(r => r.topic === topic);
                    if (relay) {
                        updateRelayState(relay.id, payload);
                        updateLastUpdateTime();
                    }
                });
                
                mqttClient.on('error', function(err) {
                    console.error('MQTT Error:', err);
                    updateConnectionStatus('disconnected');
                    updateStats();
                });
                
                mqttClient.on('close', function() {
                    console.log('Disconnected from MQTT broker');
                    updateConnectionStatus('disconnected');
                    updateStats();
                });
                
                mqttClient.on('reconnect', function() {
                    console.log('Reconnecting to MQTT broker...');
                    updateConnectionStatus('connecting');
                    updateStats();
                });
                
            } catch (err) {
                console.error('MQTT Connection Error:', err);
                updateConnectionStatus('disconnected');
                updateStats();
            }
        }
        
        function disconnectFromMQTT() {
            if (mqttClient) {
                mqttClient.end();
                mqttClient = null;
                updateConnectionStatus('disconnected');
                updateStats();
            }
        }
        
        function updateConnectionStatus(status) {
            const statusText = connectionStatus.querySelector('span:last-child');
            
            // Remove all classes and add the appropriate one
            connectionDot.className = 'connection-dot';
            connectionDot.classList.add(status === 'connected' ? 'connected' : 
                                      status === 'connecting' ? 'connecting' : 'disconnected');
            
            statusText.textContent = status === 'connected' ? 'Connected' : 
                                   status === 'connecting' ? 'Connecting...' : 'Disconnected';
            
            connectBtn.textContent = status === 'connected' ? 'Disconnect' : 'Connect';
            
            // Update MQTT status in stats
            mqttStatusSpan.textContent = status === 'connected' ? 'Online' : 
                                        status === 'connecting' ? 'Connecting...' : 'Offline';
            mqttStatusSpan.className = 'text-2xl font-bold ' + 
                                      (status === 'connected' ? 'text-green-500' : 
                                       status === 'connecting' ? 'text-yellow-500' : 'text-red-500');
        }
        
        function openSettings() {
            settingsPanel.classList.add('open');
        }
        
        function closeSettings() {
            settingsPanel.classList.remove('open');
        }
        
        function addNewRelay() {
            const name = document.getElementById('relay-name').value.trim();
            const topic = document.getElementById('relay-topic').value.trim();
            const initialState = document.getElementById('relay-initial-state').value;
            const icon = document.getElementById('relay-icon').value;
            
            if (!name || !topic) {
                alert('Please fill in all required fields');
                return;
            }
            
            const newRelay = {
                id: 'relay-' + Date.now(),
                name: name,
                topic: topic,
                state: initialState,
                icon: icon,
                lastUpdate: null
            };
            
            createRelayCard(newRelay);
            relayCards.push(newRelay);
            saveRelaysToStorage();
            
            // Subscribe to the topic if connected
            if (mqttClient && mqttClient.connected) {
                mqttClient.subscribe(topic, { qos: 1 }, function(err) {
                    if (!err) {
                        console.log(`Subscribed to ${topic}`);
                        updateStats();
                    }
                });
            }
            
            addRelayModal.classList.add('hidden');
            // Reset form
            document.getElementById('relay-name').value = '';
            document.getElementById('relay-topic').value = '';
            document.getElementById('relay-initial-state').value = 'off';
            document.getElementById('relay-icon').value = 'fa-lightbulb';
        }
        
        function createRelayCard(relayData) {
            const cardElement = document.createElement('div');
            cardElement.id = relayData.id;
            cardElement.className = 'relay-card neumorphic p-2 rounded-xl';
            
            // Determine icon class based on relay state
            const iconClass = relayData.icon || 'fa-lightbulb';
            const iconColor = relayData.state === 'on' ? 'text-yellow-200' : 'text-gray-500';
            
            cardElement.innerHTML = `
 <div class="bg-gradient-to-br from-gray-200 to-gray-300 p-4 rounded-2xl shadow-inner border border-gray-300 flex flex-col justify-between h-full text-sm space-y-2">
  <!-- Header: Title & Edit -->
  <div class="flex justify-between items-start">
    <div class="overflow-hidden">
      <h3 class="text-sm font-semibold text-gray-700 leading-tight">${relayData.name}</h3>
      <p title="${relayData.topic}" class="text-xs text-gray-300 overflow-hidden text-ellipsis whitespace-nowrap max-w-[120px]">${relayData.topic}</p>

    </div>
    <button class="text-gray-400 hover:text-blue-500 edit-relay" data-id="${relayData.id}">
      <i class="fas fa-pen text-xs"></i>
    </button>
  </div>

  <!-- Icon + Toggle -->
  <div class="flex flex-col items-center justify-center space-y-2">
    <div class="w-14 h-14 rounded-md flex items-center justify-center bg-gray-300 text-gray-600">
      <i class="${iconClass} ${iconColor} text-lg"></i>
    </div>
    <div class="flex items-center gap-2">
      <span class="relay-status ${relayData.state === 'on' ? 'on' : 'off'} w-2.5 h-2.5 rounded-full"></span>
      <label class="neumorphic-toggle">
        <input type="checkbox" ${relayData.state === 'on' ? 'checked' : ''}>
        <span class="neumorphic-slider"></span>
      </label>
    </div>
  </div>

  <!-- Last Update -->
  <div class="text-[11px] text-gray-400 flex items-center justify-start">
    <i class="fas fa-clock mr-1"></i>
    <span class="last-update">${relayData.lastUpdate || 'Never updated'}</span>
  </div>
</div>

            `;
            
            // Add event listeners
            const toggle = cardElement.querySelector('input[type="checkbox"]');
            toggle.addEventListener('change', function() {
                toggleRelay(relayData.id, this.checked ? 'on' : 'off');
            });
            
            const editBtn = cardElement.querySelector('.edit-relay');
            editBtn.addEventListener('click', () => editRelay(relayData.id));
            
            relayCardsContainer.appendChild(cardElement);
        }
        
        function toggleRelay(relayId, newState) {
            const relay = relayCards.find(r => r.id === relayId);
            if (!relay) return;
            
            relay.state = newState;
            
            // Update UI
            const cardElement = document.getElementById(relayId);
            if (cardElement) {
                const statusDot = cardElement.querySelector('.relay-status');
                statusDot.className = `relay-status ${newState === 'on' ? 'on' : 'off'}`;
                
                const icon = cardElement.querySelector('.w-14 i');
                icon.className = `${relay.icon} ${newState === 'on' ? 'text-yellow-300' : 'text-gray-600'} text-2xl`;
            }
            
            // Publish new state to MQTT if connected
            if (mqttClient && mqttClient.connected) {
                const retain = document.getElementById('retain-messages').checked;
                mqttClient.publish(relay.topic, newState, { qos: 1, retain: retain });
                console.log(`Published ${newState} to ${relay.topic}`);
            }
            
            relay.lastUpdate = new Date().toLocaleTimeString();
            updateLastUpdateTime();
            saveRelaysToStorage();
            updateStats();
        }
        
        function updateRelayState(relayId, state) {
            const relay = relayCards.find(r => r.id === relayId);
            if (!relay) return;
            
            const newState = state.toLowerCase() === 'on' ? 'on' : 'off';
            if (relay.state === newState) return;
            
            relay.state = newState;
            
            // Update UI
            const cardElement = document.getElementById(relayId);
            if (cardElement) {
                const toggle = cardElement.querySelector('input[type="checkbox"]');
                toggle.checked = newState === 'on';
                
                const statusDot = cardElement.querySelector('.relay-status');
                statusDot.className = `relay-status ${newState === 'on' ? 'on' : 'off'}`;
                
                const icon = cardElement.querySelector('.w-14 i');
                icon.className = `${relay.icon} ${newState === 'on' ? 'text-yellow-300' : 'text-gray-600'} text-2xl`;
                
                const lastUpdate = cardElement.querySelector('.last-update');
                lastUpdate.textContent = new Date().toLocaleTimeString();
            }
            
            relay.lastUpdate = new Date().toLocaleTimeString();
            saveRelaysToStorage();
            updateStats();
        }
        
        function editRelay(relayId) {
            const relay = relayCards.find(r => r.id === relayId);
            if (!relay) return;
            
            document.getElementById('edit-relay-id').value = relayId;
            document.getElementById('edit-relay-name').value = relay.name;
            document.getElementById('edit-relay-topic').value = relay.topic;
            document.getElementById('edit-relay-icon').value = relay.icon;
            
            editRelayModal.classList.remove('hidden');
        }
        
        function updateRelay() {
            const relayId = document.getElementById('edit-relay-id').value;
            const relayIndex = relayCards.findIndex(r => r.id === relayId);
            if (relayIndex === -1) return;
            
            const name = document.getElementById('edit-relay-name').value.trim();
            const topic = document.getElementById('edit-relay-topic').value.trim();
            const icon = document.getElementById('edit-relay-icon').value;
            
            if (!name || !topic) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Unsubscribe from old topic if connected and topic changed
            if (mqttClient && mqttClient.connected && relayCards[relayIndex].topic !== topic) {
                mqttClient.unsubscribe(relayCards[relayIndex].topic);
            }
            
            // Update relay data
            relayCards[relayIndex] = {
                ...relayCards[relayIndex],
                name: name,
                topic: topic,
                icon: icon
            };
            
            // Update DOM
            const cardElement = document.getElementById(relayId);
            if (cardElement) {
                cardElement.querySelector('h3').textContent = name;
                cardElement.querySelector('p').textContent = topic;
                
                const iconElement = cardElement.querySelector('.w-14 i');
                iconElement.className = `${icon} ${relayCards[relayIndex].state === 'on' ? 'text-yellow-400' : 'text-gray-400'} text-2xl`;
            }
            
            // Subscribe to new topic if connected
            if (mqttClient && mqttClient.connected) {
                mqttClient.subscribe(topic, { qos: 1 }, function(err) {
                    if (!err) {
                        console.log(`Subscribed to ${topic}`);
                    }
                });
            }
            
            saveRelaysToStorage();
            editRelayModal.classList.add('hidden');
            updateStats();
        }
        
        function deleteRelay() {
            const relayId = document.getElementById('edit-relay-id').value;
            const relayIndex = relayCards.findIndex(r => r.id === relayId);
            if (relayIndex === -1) return;
            
            if (!confirm('Are you sure you want to delete this relay?')) return;
            
            // Unsubscribe if connected
            if (mqttClient && mqttClient.connected) {
                mqttClient.unsubscribe(relayCards[relayIndex].topic);
            }
            
            // Remove from array
            relayCards.splice(relayIndex, 1);
            
            // Remove from DOM
            const cardElement = document.getElementById(relayId);
            if (cardElement) {
                cardElement.remove();
            }
            
            saveRelaysToStorage();
            editRelayModal.classList.add('hidden');
            updateStats();
        }
        
        function saveRelaysToStorage() {
            localStorage.setItem('relayControlRelays', JSON.stringify(relayCards));
            updateStats();
        }
        
        function updateStats() {
            connectedRelaysSpan.textContent = relayCards.length;
            
            const activeRelays = relayCards.filter(r => r.state === 'on').length;
            activeRelaysSpan.textContent = activeRelays;
            
            // Update last update time if any relay has been updated
            const lastUpdatedRelay = relayCards.reduce((latest, relay) => {
                if (!latest || !latest.lastUpdate) return relay;
                if (!relay.lastUpdate) return latest;
                return new Date(relay.lastUpdate) > new Date(latest.lastUpdate) ? relay : latest;
            }, null);
            
            if (lastUpdatedRelay && lastUpdatedRelay.lastUpdate) {
                lastUpdateSpan.textContent = lastUpdatedRelay.lastUpdate;
            }
        }
        
        function updateLastUpdateTime() {
            const now = new Date();
            lastUpdateSpan.textContent = now.toLocaleTimeString();
        }
    </script>
</body>
</html>